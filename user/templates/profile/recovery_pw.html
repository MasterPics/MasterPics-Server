{% extends 'core/layout.html' %}

{% load static %}

{% block content %}
<div>
    {% csrf_token %}
    <div>
        <label name="label_user_id" for="{{ form.user_id.id_for_label }}">{{ form.user_id.label }}</label>
        <div onkeyup='getUserId()'>
            {{ form.user_id }}
        </div>
    </div>
    <div>
        <label name="label_username" for="{{ form.username.id_for_label }}">{{ form.username.label }}</label>
        <div onkeyup="getUsername()">
            {{ form.username }}
        </div>
    </div>
    <div>
        <label name="label_email" for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
        <div onkeyup="getEmail()">
            {{ form.email }}
        </div>
    </div>

    <div id="div_find_pw">
        <button id="find_pw" name="recovery_pw" onclick="onClickFindPW()">비밀번호찾기</button>
    </div>

    <div id="result_pw"></div>
</div>





<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    var user_id;
    var username;
    var email;
    function getUserId() {
        user_id = document.querySelector('#pw_form_id').value;
    }
    function getUsername() {
        username = document.querySelector('#pw_form_name').value;
    }
    function getEmail() {
        email = document.querySelector('#pw_form_email').value;
    }

    
    function countdown(elementName, minutes, seconds) {
        var endTime, mins, msLeft, time;
        var element = document.querySelector(`${elementName}`);
        function twoDigits(n) {
            return (n <= 9 ? "0" + n : n);
        }
        function updateTimer() {
            msLeft = endTime - (+new Date);
            if (msLeft < 1000) {
                alert("인증시간이 초과되었습니다.");
                element.remove();
                location.href = "{% url 'profile:recovery_pw' %}"
            } else {
                time = new Date( msLeft );
                mins = time.getUTCMinutes();
                sec = time.getUTCSeconds();
                element.innerHTML = twoDigits(mins) + ':' + twoDigits(sec);
                setTimeout(updateTimer, time.getUTCMilliseconds() + 500);
            }
        }
        endTime = (+new Date) + 1000 * (60*minutes + seconds) + 500;
        updateTimer();
    }


    const onClickFindPW = () => {
        const url = '/profile/recovery/pw/find/';
        axios.post(url, {
            'user_id': user_id,
            'username': username,
            'email': email,
            'csrfmiddlewaretoken': '{{ csrf_token }}',
        })
        .then(function (response) {
            alert('회원님의 이메일로 인증코드를 발송하였습니다.');
            var result_pw = document.querySelector('#result_pw');
            result_pw.innerHTML = `<<hr>
                                    <div>
                                        <form>
                                            <div>
                                                <label for="input_auth_num">
                                                    인증번호 입력 (<span id="timeset"></span>)
                                                </label>
                                                <input type="text" id="input_auth_num" onkeyup="getAuthNum()"/>
                                            </div>
                                        </form>`+
                                        `<button type="submit" name="auth_confirm" id="id_auth_confirm" onclick="authConfirm()">
                                            <i class="fas fa-check"></i>인증확인
                                        </button>
                                    </div>`;
            countdown("#timeset", 5, 0);            
        })
        .catch(function (error) {
            if (user_id == "" || username == "" || email == "") {
                alert('아이디, 이름, 이메일을 모두 입력해주세요.');
            } else {
                alert('입력하신 정보가 일치하지 않거나 존재하지 않습니다.');
            }
        })
    };
            

</script>

{% endblock content%}